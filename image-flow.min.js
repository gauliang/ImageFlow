+function(Core){if(!window.jQuery){throw new Error("ImageFlow 依赖 jQuery ！")}if(window&&window.jQuery){Core(window,window.jQuery)}}(function(global,$){var version="1.0.0";var imageFlow=function(){this.version=version};var Core=function(opts){this.data={timer:null,colWidth:0,currentRow:0,rowHeight:0,row:0,col:0,scale:0,colpos:[],articles:[],articlesTemp:[],source:null,target:null};this.options={scope:"",scale:"16:9",colspan:1.85,rowspan:0.7,gutter:10,tpl:'<a href="{link}"></a><div class="info"><h3>{title}</h3><p>{desc}</p><span>作者：{author}</span></div>',screen:{breakpoints:[768,960,1200,1600],typeList:["xs","sm","md","lg","hg"]},grid:{hg:{col:6,row:2},lg:{col:5,row:2},md:{col:4,row:3},sm:{col:3,row:4},xs:{col:2,row:5}}}};Core.prototype.init=function(opts){var that=this;this.extend(this.options,opts);console.log(this.options);this.data.row=this.options.grid[this.scrrenType()].row;this.data.col=this.options.grid[this.scrrenType()].col;for(var i=0;i<this.data.row;i++){this.data.colpos.push(0)}this.data.source=$(this.options.scope);this.data.colWidth=Math.round((this.data.source.width()-(this.data.col-1)*this.options.gutter)/this.data.col);this.data.scale=parseInt(this.options.scale.split(":")[1])/parseInt(this.options.scale.split(":")[0]);this.data.rowHeight=this.data.colWidth*this.data.scale;this.data.target=$(document.createElement("div"));this.data.target.addClass("viewport");this.data.target.css({height:this.data.row*this.data.rowHeight+this.options.gutter*(this.data.row-1)});this.data.source.append(this.data.target);$.each(this.data.source.find(".col"),function(i,n){that.data.articles.push({title:$(n).attr("data-title"),image:$(n).attr("src"),desc:$(n).attr("data-desc"),author:$(n).attr("data-author"),link:$(n).attr("data-link")})});$(window).resize(function(){that.onResize()});that.recursion(this.data.articles)};Core.prototype.scrrenType=function(){var width=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth;for(var i=0;i<this.options.screen.breakpoints.length;i++){if(width<this.options.screen.breakpoints[i]){return this.options.screen.typeList[i]}}return"hg"};Core.prototype.onResize=function(){var that=this;if(this.data.timer){clearTimeout(this.data.timer);this.data.timer=setTimeout(function(){that.flush()},300)}else{this.data.timer=setTimeout(function(){that.flush()},300)}};Core.prototype.flush=function(){this.data.target.remove();this.data.currentRow=0;this.data.colpos=[];this.data.articles=new Array();this.data.articlesTemp=[];this.init(this.scope)};Core.prototype.insertTempArticle=function(){var _arr=[];if(this.data.articlesTemp.length>0){for(var i=0;i<this.data.articlesTemp.length;i++){if(this.data.articlesTemp[i].iteminfo.flag!="inserted"){_arr.push(this.data.articlesTemp[i])}}this.data.articlesTemp=_arr}if(this.data.articlesTemp.length>0){for(var i=0;i<this.data.articlesTemp.length;i++){this.data.articlesTemp[i].index=i;if(this.insertElement(this.data.articlesTemp[i])>=this.data.col){return}}}};Core.prototype.extend=function(target,source){for(var key in source){if(source.hasOwnProperty(key)){if(typeof source[key]=="object"){this.extend(target[key],source[key])}else{target[key]=source[key]}}}};Core.prototype.recursion=function(list){var that=this;if(list.length>0){var item=list.shift();that.insertTempArticle();var wrap=this.options.tpl.replace(/\{(.+?)\}/g,function(word){return item[word.substring(1,word.length-1)]});var article={};var _img=$(new Image());_img.bind("load",function(){article.naturalWidth=_img[0].naturalWidth;article.naturalHeight=_img[0].naturalHeight;article.image=_img;article.wrap=wrap;article.iteminfo=item;if(that.insertElement(article)<that.data.col){that.recursion(list)}else{return}});_img.attr({"src":item.image})}else{return}};Core.prototype.insertElement=function(article){var _row=this.data.currentRow;var _col=this.data.colpos[_row];var _scale=article.naturalWidth/article.naturalHeight;var _colwith=0;var _colheight=0;var element=$(document.createElement("div")).addClass("col").append(article.wrap);element.append(article.image);if(article.naturalWidth/article.naturalHeight>this.options.colspan){if(this.data.col-(_col+2)>=0){var col=this.data.target.append();_colwith=this.data.colWidth*2+this.options.gutter;_colheight=this.data.rowHeight;this.imageFix(article.image,_scale,_colwith,_colheight);element.css({"width":_colwith,"height":_colheight,"left":this.data.colpos[_row]*this.data.colWidth+this.data.colpos[_row]*this.options.gutter,"top":_row*this.data.rowHeight+_row*this.options.gutter});this.data.target.append(element);if(article.iteminfo.flag=="temp"){this.data.articlesTemp[article.index].iteminfo.flag="inserted"}this.data.colpos[_row]+=2;this.data.currentRow=this.getMinimumRow()}else{if(article.iteminfo.flag!="temp"){article.iteminfo.flag="temp";article.iteminfo.failed=0;this.data.articlesTemp.push(article)}if(article.iteminfo.failed>10){this.data.articlesTemp.shift()}article.iteminfo.failed++}}else{if(article.naturalWidth/article.naturalHeight<this.options.rowspan){if(this.data.row-(_row+2)>=0&&this.data.colpos[_row]>=this.data.colpos[_row+1]&&this.data.col-(_col+1)>=0){_colwith=this.data.colWidth;
_colheight=this.data.rowHeight*2+this.options.gutter;this.imageFix(article.image,_scale,_colwith,_colheight);element.css({"width":_colwith,"height":_colheight,"left":this.data.colpos[_row]*this.data.colWidth+this.data.colpos[_row]*this.options.gutter,"top":_row*this.data.rowHeight+_row*this.options.gutter});this.data.target.append(element);if(article.iteminfo.flag=="temp"){this.data.articlesTemp[article.index].iteminfo.flag="inserted"}this.data.colpos[_row]++;this.data.colpos[_row+1]++;this.data.currentRow=this.getMinimumRow()}else{if(article.iteminfo.flag!="temp"){article.iteminfo.flag="temp";article.iteminfo.failed=0;this.data.articlesTemp.push(article)}if(article.iteminfo.failed>10){this.data.articlesTemp.shift()}article.iteminfo.failed++}}else{if(this.data.col-(_col+1)>=0){_colwith=this.data.colWidth;_colheight=this.data.rowHeight;this.imageFix(article.image,_scale,_colwith,_colheight);element.css({"width":_colwith,"height":_colheight,"left":this.data.colpos[_row]*this.data.colWidth+this.data.colpos[_row]*this.options.gutter,"top":_row*this.data.rowHeight+_row*this.options.gutter});this.data.target.append(element);this.data.colpos[_row]++;this.data.currentRow=this.getMinimumRow()}else{}}}return this.data.colpos[this.getMinimumRow()]};Core.prototype.imageFix=function(image,_scale,_colwith,_colheight){if(_scale<=_colwith/_colheight){image.css({"width":_colwith,"top":0-(_colwith/_scale-_colheight)/2})}else{image.css({"height":_colheight,"left":0-(_colheight*_scale-_colwith)/2})}};Core.prototype.getMinimumRow=function(){var lowest=0;var arr=this.data.colpos;for(var i=1;i<arr.length;i++){if(arr[i]<arr[lowest]){lowest=i}}return lowest};imageFlow.prototype.create=function(scope,opts){$.extend((opts||{}),{scope:scope});(new Core()).init(opts)};window.ImageFlow=new imageFlow});